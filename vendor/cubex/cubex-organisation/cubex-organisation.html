<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../../app-route/app-location.html">
<link rel="import" href="../../app-route/app-route.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <cubex-organisation organisation="{{organisation}}"></cubex-organisation>

@demo demo/index.html
-->

<dom-module id="cubex-organisation" attributes="organisation organisations">
  <template>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:org" data="{{routeData}}"></app-route>
    <cube-websocket vendor="cubex" app="organisations" auto
                    on-subscribe="_orgSubscribed" on-message="_orgUpdate"></cube-websocket>
  </template>
  <script>
    Polymer(
      {
        is:             'cubex-organisation',
        properties:     {
          organisation:  {type: Object, notify: true},
          organisations: {type: Object, notify: true, readOnly: true}
        },
        observers:      ['_orgChanged(organisations,routeData.org)'],
        _orgSubscribed: function (e, message)
                        {
                          this._setOrganisations(JSON.parse(message).organisations);
                        },
        _orgUpdate:     function (e, message)
                        {
                          if(message.action == 'create')
                          {
                            this.set('organisations.' + message.payload.id, message.payload);
                          }
                        },
        _orgChanged:    function ()
                        {
                          if(this.organisations && this.routeData.org)
                          {
                            this.set('organisation', this.organisations[this.routeData.org]);
                          }
                        }
      }
    );
  </script>
</dom-module>
