<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../cubex-route/cubex-route.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <cubex-project project="{{project}}"></cubex-project>

@demo demo/index.html
-->

<dom-module id="cubex-project" attributes="project projects">
  <template>
    <cubex-route project-id="{{projectId}}"></cubex-route>
    <cube-websocket auto project="[[projectId]]" vendor="cubex" app="projects"
                    on-subscribe="_projectSubscribed" on-message="_projectUpdate"></cube-websocket>
  </template>
  <script>
    Polymer(
      {
        is:                 'cubex-project',
        properties:         {
          project:  {type: Object, notify: true, readOnly: true},
          projects: {type: Object, value: function () {return {};}, notify: true, readOnly: true}
        },
        observers:          ['_projectChanged(projects,projectId)'],
        _projectSubscribed: function (e, message)
                            {
                              this._setProjects(JSON.parse(message).projects || {});
                            },
        _projectUpdate:     function (e, message)
                            {
                              var projects = this.projects;
                              if(message.action == 'create' || message.action == 'join')
                              {
                                projects[message.payload.id] = message.payload;
                                this._setProjects(projects);
                              }
                              else if(message.action == 'leave')
                              {
                                delete projects[message.payload];
                                this._setProjects(projects);
                              }
                            },
        _projectChanged:    function ()
                            {
                              if(this.projects && this.projectId)
                              {
                                this._setProject(this.projects[this.projectId]);
                              }
                            }
      }
    );
  </script>
</dom-module>
