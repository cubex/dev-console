<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../../cube-behavior/cube-service-behavior.html">
<link rel="import" href="../cubex-route/cubex-route.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <cubex-project project="{{project}}"></cubex-project>

@demo demo/index.html
-->

<dom-module id="cubex-project" attributes="project-id project projects invites">
  <template>
    <cubex-route project-id="{{projectId}}"></cubex-route>
    <cube-websocket auto project="[[projectId]]" vendor="kubex" app="project"
                    on-subscribe="_projectSubscribed" on-message="_projectUpdate"></cube-websocket>
    <cube-resource auto auth url="//[[getServiceHost('apps')]]/kubex/project/invites.json"
                   data="{{_invites}}"></cube-resource>
  </template>
  <script>
    Polymer(
      {
        is:                 'cubex-project',
        properties:         {
          _subscribed:     {type: Boolean, value: false},
          projectId:       {type: String, notify: true},
          project:         {type: Object, notify: true, readOnly: true},
          projects:        {
            type:  Array, notify: true, readOnly: true,
            value: function () {return [];}
          },
          invites:         {
            type:  Array, notify: true, readOnly: true,
            value: function () {return [];}, computed: '_computeInvites(_invites)'
          },
          _invites:        {type: Object, value: function () {return {};}},
          _projectsObject: {type: Object, value: function () {return {};}}
        },
        observers:          ['_projectChanged(projects,projectId)'],
        _computeInvites:    function (invites)
                            {
                              if(invites && invites.Invites)
                              {
                                return invites.Invites;
                              }
                              return [];
                            },
        _projectSubscribed: function (e, message)
                            {
                              var projects = JSON.parse(message).projects || [];
                              this._projectsObject = projects;
                              this._subscribed = true;
                              this._setProjects(Object.keys(projects).map(function (i) {return projects[i];}));
                            },
        _projectUpdate:     function (e, message)
                            {
                              var projects = this.projects;
                              if(message.action === 'create' || message.action === 'join')
                              {
                                this.push('projects', message.payload);
                              }
                              else if(message.action === 'leave')
                              {
                                for(var i in this.projects)
                                {
                                  if(this.projects.hasOwnProperty(i))
                                  {
                                    if(this.projects[i].id === message.payload.id)
                                    {
                                      this.splice('projects', i, 1);
                                      break;
                                    }
                                  }
                                }
                              }
                            },
        _projectChanged:    function ()
                            {
                              if(this._projectsObject && this.projectId)
                              {
                                if(this._subscribed && !this._projectsObject[this.projectId])
                                {
                                  window.location = '//' + this.getServiceHost('console');
                                }
                                else
                                {
                                  this._setProject(this._projectsObject[this.projectId]);
                                }
                              }
                            },
        behaviors:          [
          Polymer.CubeServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
