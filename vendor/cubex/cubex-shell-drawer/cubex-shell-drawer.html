<link href="../../polymer/polymer.html" rel="import">
<link href="../cubex-registry/cubex-registry.html" rel="import">
<link href="../cubex-category/cubex-category.html" rel="import">
<link href="../cubex-project/cubex-project.html" rel="import">
<link href="../../iron-selector/iron-selector.html" rel="import">
<link href="../../paper-button/paper-button.html" rel="import">
<link href="../../cube-list/cube-list-menu.html" rel="import">
<link href="../../cube-list/cube-list-group.html" rel="import">
<link href="../../cube-list/cube-li.html" rel="import">
<link href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html" rel="import">
<link href="../../cube-behavior/cube-i18n-behavior.html" rel="import">
<link href="../../cube-behavior/cube-service-behavior.html" rel="import">
<link href="../cubex-pinned-apps/cubex-pinned.html" rel="import">

<dom-module id="cubex-shell-drawer">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        overflow: auto;
        height: 100%;
      }

      #user-view {
        background: var(--accent-700-color);
        position: relative;
        width: 100%;
        height: 146px;
        @apply(--paper-font-body2);
        color: var(--accent-700-text-color);
        border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      }

      #user-view strong,
      #user-view span {
        padding-left: 98px;
        display: block;
        padding-top: 26px;
      }

      #user-view span {
        padding-top: 0;
        opacity: var(--light-secondary-opacity);
      }

      #user-view img {
        border-radius: 50%;
        border: solid 3px rgba(255, 255, 255, 0.4);
        width: 64px;
        height: 64px;
        position: absolute;
        top: 17px;
        left: 13px;
      }

      .toggle {

        display: block;
        position: absolute;
        top: 90px;
        left: 0;
        right: 0;
        margin: 0;
        padding: 0 16px;
        cursor: pointer;
        text-align: left;

        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;

        text-transform: none;
        @apply(--paper-font-body2);
        height: 56px;
        line-height: 56px;
      }

      .toggle iron-icon {
        float: right;
        top: 18px;
      }

      .closer {
        position: absolute;
        z-index: 100;
        top: 0;
        left: 0;
        right: 0;
        height: 90px;
      }

      #drawerPanelContainer {
        position: relative;
        flex-grow: 1
      }

      #drawerPanels {
        height: 100%;
        width: 100%;
      }

      :host cube-list-menu {
        --cube-list-filter-color: var(--primary-800-text-secondary-color);
        --cube-list-filter-focus-color: var(--primary-800-text-color);
      }

      :host cube-li {
        @apply --primary-700;
      }

      cube-list-menu:last-of-type cube-li {
        @apply --accent-700;
      }

      cubex-shell-drawer-panel cube-list-menu:first-of-type {
        flex-grow: 1;
      }

      .category-link {
        color: inherit;
        text-decoration: none;
      }

      cubex-pinned {
        display: none;
      }

      cube-li:hover cubex-pinned {
        display: block;
      }

      cubex-pinned[pinned] {
        color: var(--accent-400-color);
        display: block;
      }

      .app-vendor {
        font-size: 12px;
      }
    </style>

    <cubex-project project="{{project}}" projects="{{_projects}}"></cubex-project>

    <cubex-registry project-data="{{_projectRegistryData}}"></cubex-registry>

    <div id="user-view">
      <cube-resource auto auth url="//[[getServiceHost('apps')]]/kubex/whoami/whoami.json"
                     data="{{whoami}}"></cube-resource>
      <paper-button on-tap="_toggleParent" class="closer"></paper-button>
      <img src="{{avatar}}">
      <strong>[[whoami.FirstName]] [[whoami.LastName]]</strong>
      <span>[[whoami.Username]]</span>
      <template is="dom-if" if="[[project]]">
        <paper-button on-tap="toggleDrawer" class="toggle" selected-drawer="{{selectedItem}}">
          [[project.name]]
          <iron-icon icon="[[_icon]]"></iron-icon>
        </paper-button>
      </template>
    </div>
    <div id="drawerPanelContainer">
      <iron-selector selected="0" id="drawerPanels">
        <slot></slot>
        <template is="dom-if" if="[[project]]">
          <cubex-shell-drawer-panel>
            <cube-list-menu show-filter filter-label="{{i18n('filter_apps')}}">
              <template is="dom-repeat" items="[[__toArray(_groupedApps)]]" as="category">
                <cube-list-group>
                  <a href="/_[[category.name]]" slot="title" on-tap="_toggleParent" class="category-link">
                    <cubex-category key="[[category.name]]"></cubex-category>
                  </a>
                  <template is="dom-repeat" items="[[__toArray(category.apps)]]" as="app">
                    <a href="/[[app.vendor_id]]/[[app.id]]" on-tap="_toggleParent">
                      <cube-li compact-icon highlight="[[app.pinned]]">
                        <cubex-pinned vendor="[[app.vendor_id]]" app="[[app.id]]" pinned="{{app.pinned}}"
                                      slot="actions"></cubex-pinned>
                        <cube-icon slot="icon" icon="[[app.icon]]"></cube-icon>
                        [[app.name]]
                        <span slot="secondary" class="app-vendor">by [[app.vendor_id]]</span>
                      </cube-li>
                    </a>
                  </template>
                </cube-list-group>
              </template>
            </cube-list-menu>
            <cube-list-menu>
              <a id="storeLink" href="/kubex/store" on-tap="_toggleParent">
                <cube-li compact-icon>
                  <cube-icon slot="icon" icon="icons:apps"></cube-icon>
                  App Store
                </cube-li>
              </a>
            </cube-list-menu>
          </cubex-shell-drawer-panel>
        </template>
        <cubex-shell-drawer-panel id="projectsPanel">
          <cube-list-menu show-filter filter-label="{{i18n('filter_projects')}}">
            <cube-list-group title="{{i18n('all_projects')}}">
              <template is="dom-repeat" items="[[_projects]]">
                <a href="//[[getServiceHost(item.alias)]]" on-tap="_toggleParent">
                  <cube-li compact-icon>
                    <cube-icon slot="icon" icon="communication:business"></cube-icon>
                    [[item.name]]
                    <div slot="secondary">[[item.alias]]</div>
                  </cube-li>
                </a>
              </template>
            </cube-list-group>
          </cube-list-menu>
          <cube-list-menu>
            <a href="//[[getServiceHost('console')]]" on-tap="_toggleParent">
              <cube-li compact-icon>
                <cube-icon slot="icon" icon="icons:settings"></cube-icon>
                Manage Projects
              </cube-li>
            </a>
          </cube-list-menu>
        </cubex-shell-drawer-panel>
      </iron-selector>
    </div>
  </template>

  <script>
    Polymer(
      {
        is:            'cubex-shell-drawer',
        properties:    {
          resources:            {
            type:  Object,
            value: {
              "en": {
                "filter_apps":     "Filter Applications",
                "filter_projects": "Filter Projects",
                "all_projects":    "All Projects"
              },
              "fr": {
                "filter_apps":     "Filtre Applications",
                "filter_projects": "Filtre les projects",
                "all_projects":    "Toutes les projects"
              }
            }
          },
          selectedItem:         {
            type:  Number,
            value: 0
          },
          _icon:                {
            type:  String,
            value: "icons:arrow-drop-down"
          },
          _projectRegistryData: {type: Object},
          _groupedApps:         {type: Object, computed: '_computeGroupedApps(_projectRegistryData)'},
          project:              {type: Object},
          avatar:               {
            type:  String,
            value: function ()
                   {
                     return "//" + this.getServiceHost('static-console') + "/resources/images/avatar/default-64.png";
                   }
          },
          headColor:            {
            type: String
          }
        },
        keyBindings:   {
          ',': 'toggleDrawer'
        },
        attached:      function ()
                       {
                         this.keyEventTarget = document.body;
                       },
        _toggleParent: function ()
                       {
                         this.parentNode.close();
                       },
        selectPanel:   function (panel)
                       {
                         this.$.drawerPanels.select(panel);
                       },
        toggleDrawer:  function ()
                       {
                         this.$.drawerPanels.selectNext();
                         this.selectedItem = this.$.drawerPanels.selected;
                         if(this.selectedItem === 1)
                         {
                           this._icon = "icons:arrow-drop-up";
                         }
                         else if(this.selectedItem === 0)
                         {
                           this._icon = "icons:arrow-drop-down";
                         }
                       },

        __toArray: function (o)
                   {
                     return Object.keys(o).map(function (i) {return o[i];});
                   },

        _computeGroupedApps: function (projectRegistry)
                             {
                               var idx, categories = {}, groups = [];

                               if(projectRegistry)
                               {
                                 for(idx in projectRegistry.AppSummary)
                                 {
                                   if(projectRegistry.AppSummary.hasOwnProperty(idx))
                                   {
                                     var app = projectRegistry.AppSummary[idx];
                                     if(this._filterApps(app))
                                     {
                                       if(!categories[app.category])
                                       {
                                         categories[app.category] = {name: app.category, apps: []};
                                       }
                                       var category = categories[app.category];

                                       if(app.group)
                                       {
                                         var groupId = app.vendor_id + '/' + app.group;
                                         if(groups.indexOf(groupId) === -1)
                                         {
                                           category.apps.push(projectRegistry.GroupSummary[groupId]);
                                           groups.push(groupId);
                                         }
                                       }
                                       else
                                       {
                                         category.apps.push(app);
                                       }
                                     }
                                   }
                                 }
                               }
                               return categories;
                             },

        _filterApps: function (item)
                     {
                       return item.app_type === 'kubex.application.project' && item.ui_mode === 'full';
                     },

        behaviors: [
          Polymer.IronA11yKeysBehavior,
          Polymer.CubeI18nBehavior,
          Polymer.CubeServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
