<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-dropdown/cube-dropdown.html">
<link rel="import" href="../../cube-action/cube-action.html">
<link rel="import" href="../../cube-list/cube-list.html">
<link rel="import" href="../../cube-icon/cube-icon.html">
<link rel="import" href="../../cube-behavior/cube-iterator-behavior.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../cubex-route/cubex-route.html">
<link rel="import" href="cubex-notification.html">

<dom-module id="cubex-notifications">
  <template>
    <style>
      :host {
        --paper-spinner-color: var(--accent-400-color);
        --paper-spinner-stroke-width: 3px;
      }

      cube-dropdown #drop {
        @apply(--shadow-elevation-4dp);
      }

      cube-list-menu {
        @apply(--primary-800);
        min-width: 350px;
        opacity: 1;
        max-height: 403px;
        overflow: auto;

        --cube-li-style: {
          color: var(--theme-2-color);
        }
      }

      :host #trigger {
        @apply --primary-700-text-secondary;
        margin: 10px 0;
      }

      :host #trigger:hover {
        @apply --primary-700-text;
      }

      :host #trigger paper-spinner-lite {
        position: absolute;
        left: 7px;
        top: 8px;
        width: 29px;
        height: 29px;
      }

      :host #trigger[unread] cube-icon {
        color: white;
      }

      :host #trigger[unread] cube-icon:before {
        content: '';
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 100px;
        padding: 0 5px;
        text-align: center;
        font-size: 9px;
        font-weight: bold;
        line-height: 15px;
        z-index: 1;
        pointer-events: none;
      }

      :host #trigger[running][unread] cube-icon:before {
        top: 0;
        right: 0;
      }

      :host #trigger[running] cube-icon {
        transform: scale(0.8);
      }

      :host cube-list-menu#content cube-action {
        margin-right: -10px;
        margin-left: 10px;
      }

      :host cube-li {
        text-transform: uppercase;
        @apply --primary-900;
      }

      :host cube-li a {
        color: var(--primary-800-text-color);
        text-decoration: none;
      }

      :host #settings {
        margin-right: -5px;
      }
    </style>

    <cubex-route project-id="{{projectId}}"></cubex-route>

    <cube-websocket auto project="[[projectId]]" vendor="cubex" app="notifications"
                    on-subscribe="_notificationSubscribe" on-message="_notificationMessage"></cube-websocket>

    <cube-dropdown id="dd" horizontal-align="right">
      <cube-action id="trigger" slot="trigger" running$="[[_running]]" unread$="[[_unread]]">
        <paper-spinner-lite active="[[_running]]"></paper-spinner-lite>
        <cube-icon icon="social:notifications"></cube-icon>
      </cube-action>
      <div id="drop">
        <cube-li>
          Notifications
          <a id="settings" href="/cubex/notifications/_configure" slot="actions">
            <cube-action size="20" icon="icons:settings"></cube-action>
          </a>
        </cube-li>
        <cube-list-menu id="content">
          <template id="notificationList" is="dom-repeat" items="[[_notificationsArray]]">
            <cubex-notification notification="[[item]]"></cubex-notification>
          </template>
        </cube-list-menu>

        <cube-li>
          <a href="/cubex/notifications">
            <cube-action>See All</cube-action>
          </a>
          <cube-action on-tap="_markRead" slot="actions">Mark all As Read</cube-action>
        </cube-li>
      </div>
    </cube-dropdown>
  </template>

  <script>
    Polymer(
      {
        is:         'cubex-notifications',
        properties: {
          _running:            {type: Boolean, computed: '__hasRunning(_notifications)'},
          _unread:             {type: Boolean, computed: '__hasUnread(_notifications)'},
          _notifications:      {type: Object, value: function () {return {};}},
          _notificationsArray: {
            type:     Array,
            value:    function () {return [];},
            computed: '_computeNotifications(_notifications)',
            observer: '_updateList'
          }
        },

        _notificationSubscribe: function (e)
                                {
                                  if(e.detail)
                                  {
                                    var notes = JSON.parse(e.detail);
                                    for(var i in notes)
                                    {
                                      if(notes.hasOwnProperty(i))
                                      {
                                        this._notifications[notes[i].NotificationUid] = notes[i];
                                      }
                                    }
                                    this.notifyPath('_notifications');
                                  }
                                },
        _notificationMessage:   function (e)
                                {
                                  if(e.detail.action == 'update' || e.detail.action == 'send')
                                  {
                                    this._notifications[e.detail.payload.NotificationUid] = e.detail.payload;
                                    this.notifyPath('_notifications');
                                  }
                                  else if(e.detail.action == 'read')
                                  {
                                    if(this._notifications[e.detail.payload])
                                    {
                                      this._notifications[e.detail.payload].Read = true;
                                      this.notifyPath('_notifications');
                                    }
                                  }
                                },

        _updateList: function ()
                     {
                       Polymer.RenderStatus.afterNextRender(
                         function ()
                         {
                           this.$.dd.refit();
                         }.bind(this)
                       );
                     },

        _computeNotifications: function ()
                               {
                                 var notes = this._notifications;
                                 return Object.keys(notes)
                                              .map(function (key) { return notes[key]; })
                                              .sort(this.__sortNotifications)
                                              .slice(0, 30);
                               },

        __sortNotifications: function (a, b)
                             {
                               if((a.Percentage == b.Percentage) && (a.Percentage == 100))
                               {
                                 var updateReturn = 0;
                                 if(a.UpdateTime != b.UpdateTime)
                                 {
                                   updateReturn = a.UpdateTime > b.UpdateTime ? -1 : 1;
                                 }
                                 return updateReturn;
                               }
                               if(a.Percentage < 100 && b.Percentage < 100)
                               {
                                 var startReturn = 0;
                                 if(a.StartTime != b.StartTime)
                                 {
                                   startReturn = a.StartTime > b.StartTime ? -1 : 1;
                                 }
                                 return startReturn;
                               }
                               if(a.Percentage < 100)
                               {
                                 return -1;
                               }
                               if(b.Percentage < 100)
                               {
                                 return 1;
                               }
                               return 0;
                             },

        __hasRunning: function (notifications)
                      {
                        return !!this.iterate(
                          notifications, function (item)
                          {
                            if(item.Percentage < 100)
                            {
                              return true;
                            }
                          }
                        );
                      },

        __hasUnread: function (notifications)
                     {
                       return !!this.iterate(
                         notifications, function (item)
                         {
                           if(item.Percentage >= 100 && !item.Read)
                           {
                             return true;
                           }
                         }
                       );
                     },

        _markRead: function ()
                   {
                     var xhr = new XMLHttpRequest();
                     xhr.open(
                       'PUT',
                       '//' + this.getServiceHost('apps') + '/cubex/notifications/read/all'
                     );
                     xhr.setRequestHeader('x-cube-project', this.projectId);
                     xhr.withCredentials = true;
                     xhr.send();
                   },

        behaviors: [
          Polymer.CubeIteratorBehavior,
          Polymer.CubeServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
