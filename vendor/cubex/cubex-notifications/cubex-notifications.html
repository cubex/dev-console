<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-dropdown/cube-dropdown.html">
<link rel="import" href="../../cube-action/cube-action.html">
<link rel="import" href="../../cube-list/cube-list.html">
<link rel="import" href="../../cube-list/cube-list-menu.html">
<link rel="import" href="../../cube-icon/cube-icon.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../../cube-repeat/cube-repeat.html">
<link rel="import" href="../cubex-configure/cubex-configure-dialog.html">
<link rel="import" href="../cubex-route/cubex-route.html">
<link rel="import" href="cubex-notification.html">
<link rel="import" href="../../bind-factory/bind-factory.html">

<dom-module id="cubex-notifications">
  <template>
    <style>
      :host {
        --paper-spinner-color: var(--accent-400-color);
        --paper-spinner-stroke-width: 3px;
      }

      cube-dropdown #drop {
        overflow: visible;
        @apply(--shadow-elevation-4dp);
      }

      cube-list, cube-list-menu {
        @apply(--primary-800);
        min-width: 350px;
        opacity: 1;
        max-height: 403px;
        overflow: auto;

        --cube-li-style: {
          color: var(--theme-2-color);
        }
      }

      :host #trigger {
        @apply --primary-700-text-secondary;
        margin: 10px 0;
      }

      :host #trigger:hover {
        @apply --primary-700-text;
      }

      :host #trigger paper-spinner-lite {
        position: absolute;
        left: 7px;
        top: 8px;
        width: 29px;
        height: 29px;
      }

      :host #trigger[unread] cube-icon {
        color: white;
      }

      :host #trigger[unread] cube-icon:before {
        content: '';
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 100px;
        padding: 0 5px;
        text-align: center;
        font-size: 9px;
        font-weight: bold;
        line-height: 15px;
        z-index: 1;
        pointer-events: none;
      }

      :host #trigger[running][unread] cube-icon:before {
        top: 0;
        right: 0;
      }

      :host #trigger[running] cube-icon {
        transform: scale(0.8);
      }

      :host cube-list-menu#content cube-action {
        margin-right: -10px;
        margin-left: 10px;
      }

      :host cube-li.uc {
        text-transform: uppercase;
        @apply --primary-900;
      }

      :host cube-li a {
        color: var(--primary-800-text-color);
        text-decoration: none;
      }

      :host #settings {
        margin-right: -5px;
      }

      a[disabled], div[disabled] {
        @apply --text-disabled;
      }
    </style>

    <cubex-route project-id="{{projectId}}"></cubex-route>

    <cube-websocket auto project="[[projectId]]" vendor="kubex" app="notify"
                    on-subscribe="_notificationSubscribe" on-message="_notificationMessage"></cube-websocket>

    <cube-dropdown id="dd" horizontal-align="right">
      <cube-action id="trigger" slot="trigger" running$="[[_running]]" unread$="[[_unread]]">
        <paper-spinner-lite active="[[_running]]"></paper-spinner-lite>
        <cube-icon icon="social:notifications"></cube-icon>
      </cube-action>
      <div id="drop">
        <cube-li class="uc">
          Notifications
          <cube-action slot="actions" id="settings" on-tap="__openCfg" size="20" icon="icons:settings"></cube-action>
          <cubex-configure-dialog id="configDlg" gaid="kubex/notify"></cubex-configure-dialog>
        </cube-li>

        <template is="dom-if" if="[[_notifications.length]]">
          <cube-list-menu id="content">
            <cube-repeat items="[[_notifications]]" limit="20" sort="__sortNotifications">
              <template>
                <cubex-notification notification="[[item]]"></cubex-notification>
              </template>
            </cube-repeat>
          </cube-list-menu>
        </template>

        <template is="dom-if" if="[[!_notifications.length]]">
          <cube-list>
            <cube-li multi-line>You have no notifications</cube-li>
          </cube-list>
        </template>

        <cube-li class="uc">
          <a href="/kubex/notify" class="can-disable" disabled$="[[!_notifications.length]]">
            <cube-action>See All</cube-action>
          </a>
          <div slot="actions" class="can-disable" disabled$="[[!_notifications.length]]">
            <cube-action on-tap="_markRead">
              Mark all As Read
            </cube-action>
          </div>
        </cube-li>
      </div>
    </cube-dropdown>
  </template>

  <script>
    Polymer(
      {
        is:         'cubex-notifications',
        properties: {
          _running:             {type: Boolean, notify: true, computed: '__hasRunning(_notificationStatus)'},
          _unread:              {type: Boolean, notify: true, computed: '__hasUnread(_notificationStatus)'},
          _notifications:       {type: Array, notify: true, value: function () {return [];}},
          _notificationIndexes: {type: Object, notify: true, value: function () {return {};}},
          _isReady:             {type: Boolean, value: false}
        },

        attached: function ()
                  {
                    var
                      elements = this.root.querySelectorAll('.can-disable'),
                      fn = function (e)
                      {
                        if(this.hasAttribute('disabled'))
                        {
                          e.preventDefault();
                        }
                      };

                    for(var i in elements)
                    {
                      if(elements.hasOwnProperty(i))
                      {
                        var ele = elements[i];
                        ele.addEventListener('tap', fn.bind(ele));
                      }
                    }
                  },

        _notificationSubscribe: function (e)
                                {
                                  if(e.detail)
                                  {
                                    var notes = JSON.parse(e.detail);
                                    if(notes)
                                    {
                                      for(var i in notes)
                                      {
                                        if(notes.hasOwnProperty(i))
                                        {
                                          this._updateNotification(notes[i]);
                                        }
                                      }
                                      this._invalidateProperties();
                                    }
                                  }
                                  this._isReady = true;
                                },
        _notificationMessage:   function (e)
                                {
                                  if(!this._isReady)
                                  {
                                    return setTimeout(function () {this._notificationMessage(e);}.bind(this), 500);
                                  }

                                  if(e.detail.action === 'send')
                                  {
                                    this._updateNotification(e.detail.payload);
                                  }
                                  else if(e.detail.action === 'update')
                                  {
                                    this._updateNotification(e.detail.payload);
                                  }
                                  else if(e.detail.action === 'read')
                                  {
                                    this._updateNotification(
                                      {notification_uid: e.detail.payload, read: true}
                                    );
                                  }
                                  else if(e.detail.action === 'readall')
                                  {
                                    for(var i in this._notifications)
                                    {
                                      if(this._notifications.hasOwnProperty(i))
                                      {
                                        var note = this._notifications[i];
                                        if(
                                          (!note.read)
                                          && ((!note.last_update) || (note.last_update <= e.detail.payload.timestamp))
                                        )
                                        {
                                          this.set(['_notifications', i, 'read'], true);
                                        }
                                      }
                                    }
                                  }
                                },

        _updateNotification: function (newState)
                             {
                               var idx = this._notificationIndexes[newState.notification_uid];
                               if(!idx)
                               {
                                 // no index, push notification
                                 this._notificationIndexes[newState.notification_uid]
                                   = this.push('_notifications', newState) - 1;
                               }
                               else if((!newState.last_update)
                                 || this._notifications[idx].last_update < newState.last_update)
                               {
                                 for(var key in newState)
                                 {
                                   if(newState.hasOwnProperty(key))
                                   {
                                     this.set(['_notifications', idx, key], newState[key], false);
                                   }
                                 }
                               }
                             },

        __sortNotifications: function (a, b)
                             {
                               if(a.percentage < b.percentage)
                               {
                                 return -1;
                               }
                               if(a.percentage > b.percentage)
                               {
                                 return 1;
                               }

                               if(a.last_update > b.last_update)
                               {
                                 return -1;
                               }
                               if(a.last_update < b.last_update)
                               {
                                 return 1;
                               }
                               return 0;
                             },

        __hasRunning: function (statuses)
                      {
                        for(var i in statuses)
                        {
                          if(statuses.hasOwnProperty(i) && statuses[i].percentage < 100)
                          {
                            return true;
                          }
                        }
                        return false;
                      },
        __hasUnread:  function (statuses)
                      {
                        for(var i in statuses)
                        {
                          if(statuses.hasOwnProperty(i) && statuses[i].percentage >= 100 && !statuses[i].read)
                          {
                            return true;
                          }
                        }
                        return false;
                      },

        _getStatus: function (id)
                    {
                      return this._notificationIndexes[id];
                    },

        _markRead: function ()
                   {
                     var xhr = new XMLHttpRequest();
                     xhr.open(
                       'PUT',
                       '//' + this.getServiceHost('apps') + '/kubex/notify/read/all'
                     );
                     xhr.setRequestHeader('x-requested-by', 'cubex-notifications');
                     xhr.withCredentials = true;
                     xhr.send();
                   },

        __openCfg: function ()
                   {
                     this.$.configDlg.open();
                   },

        behaviors: [
          Polymer.CubeServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
