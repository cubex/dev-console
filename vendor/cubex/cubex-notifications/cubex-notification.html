<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-list/cube-li.html">
<link rel="import" href="../../cube-icon/cube-icon.html">
<link rel="import" href="../../cube-behavior/cube-iterator-behavior.html">
<link rel="import" href="../../cube-behavior/cube-i18n-behavior.html">
<link rel="import" href="../../cube-time/cube-time.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../cubex-app/cubex-app-definition.html">
<link rel="import" href="../cubex-route/cubex-route.html">
<link rel="import" href="cubex-notification-definition.html">

<dom-module id="cubex-notification" attributes="notification">
  <template>
    <style>
      :host {
        display: block;
      }

      :host #state {
        margin-right: -5px;
      }

      :host #state > div, :host #spinner {
        display: inline-block;
        position: relative;
        width: 28px;
        height: 28px;
        text-align: center;
      }

      :host #state > div::before {
        position: absolute;
        top: calc(5px + var(--paper-spinner-stroke-width));
        right: calc(5px + var(--paper-spinner-stroke-width));
        bottom: calc(5px + var(--paper-spinner-stroke-width));
        left: calc(5px + var(--paper-spinner-stroke-width));
        content: '';
        border-radius: 1000px;
        border: 2px solid var(--primary-700-text-color, #666666);
      }

      :host(:not([read])) #state > div::before {
        background: var(--primary-700-text-color, #666666);
      }

      :host(:not([read])) {
        @apply --primary-700;
      }

      :host([read]) {
        @apply --primary-800;
      }

      #spinner paper-spinner-lite {
        position: absolute;
        left: 0;
        top: 0;
      }
    </style>

    <cubex-route project-id="{{projectId}}"></cubex-route>

    <cubex-notification-definition notification-id="[[notification.NotificationId]]"
                                   definition="{{definition}}"></cubex-notification-definition>

    <cube-li multi-line>
      <cube-icon slot="icon" icon="[[definition.Icon]]"></cube-icon>
      [[i18nData_c4t(definition.ID,'_message','',notification.Data)]]
      <div slot="secondary">
        <cube-time input-format="X" datetime="[[notification.UpdateTime]]" from="now">
          [[_dateTime(notification.UpdateTime)]]
        </cube-time>
      </div>

      <template is="dom-if" if="[[running]]">
        <div id="spinner" slot="actions">
          <paper-spinner-lite active="[[running]]" title="[[definition.message]]"></paper-spinner-lite>
          [[notification.Percentage]]
        </div>
      </template>
      <template is="dom-if" if="[[!running]]">
        <cube-action id="state" slot="actions" on-tap="_markRead">
          <div></div>
        </cube-action>
      </template>
    </cube-li>
  </template>

  <script>
    Polymer(
      {
        is:         'cubex-notification',
        properties: {
          notification: {type: Object},
          definition:   {type: Object, observer: '_resetResources'},
          resources:    {type: Object, value: this._resetResources},
          running:      {
            type:               Boolean,
            readOnly:           true,
            reflectToAttribute: true,
            computed:           '_computeRunning(notification.Percentage)'
          },
          read:         {
            type:               Boolean,
            readOnly:           true,
            reflectToAttribute: true,
            computed:           '_computeRead(notification.Read)'
          }
        },

        _computeRead: function (read)
                      {
                        return !!read;
                      },

        _computeRunning: function (percentage)
                         {
                           return percentage < 100;
                         },

        _dateTime: function (updateTime)
                   {
                     return (new Date(updateTime * 1000)).toISOString();
                   },

        _resetResources: function (def)
                         {
                           var newRes = {};
                           if(def)
                           {
                             newRes[def.ID + '_message'] = def.Message;
                             newRes[def.ID + '_description'] = def.Description;
                             newRes[def.ID + '_path'] = def.Path;
                           }
                           this.hydrateResources(newRes, true);
                         },

        _markRead: function ()
                   {
                     var xhr = new XMLHttpRequest();
                     xhr.open(
                       'PUT',
                       '//' + this.getServiceHost('apps') + '/cubex/notifications/read/' + this.notification.NotificationUid
                     );
                     xhr.setRequestHeader('x-cube-project', this.projectId);
                     xhr.withCredentials = true;
                     xhr.send();
                   },

        behaviors: [
          Polymer.CubeIteratorBehavior,
          Polymer.CubeI18nBehavior,
          Polymer.CubeServiceBehavior
        ]
      }
    );
  </script>
</dom-module>
