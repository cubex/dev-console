<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../app-layout/app-header/app-header.html">
<link rel="import" href="../../paper-styles/typography.html">

<link rel="import" href="../../app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../app-layout/app-drawer-layout/app-drawer-layout.html">

<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../cube-behavior/cube-touch-enabled-behavior.html">
<link rel="import" href="../../cube-action/cube-action.html">
<link rel="import" href="../../app-route/app-location.html">

<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<link rel="import" href="../../iron-media-query/iron-media-query.html">
<link rel="import" href="../../cube-behavior/cube-iterator-behavior.html">

<link rel="import" href="../cubex-shell-drawer/cubex-shell-drawer.html">
<link rel="import" href="../cubex-shell-drawer/cubex-shell-drawer-panel.html">

<link rel="import" href="../cubex-pinned-apps/cubex-pinned-apps.html">
<link rel="import" href="../cubex-search/cubex-search.html">
<link rel="import" href="../cubex-toolbar/cubex-toolbar.html">
<link rel="import" href="../cubex-drawer/cubex-drawer.html">
<link rel="import" href="../cubex-drawer/cubex-user-drawer.html">
<link rel="import" href="../cubex-drawer/cubex-drawer-content.html">
<link rel="import" href="../cubex-app/cubex-app-loader.html">
<link rel="import" href="../../cube-preferences/cube-preferences.html">

<dom-module id="cubex-shell" attributes="drawer-opened focus-search">
  <template>
    <style>
      :host {
        --app-drawer-width: 320px;
        --cubex-drawer-offset-top: 64px;
        --cubex-drawer-peek-width: 56px;
        --cubex-drawer-width: 320px;
      }

      :host, #flex-toolbar {
        min-width: 320px;
      }

      @media screen and (max-width: 320px) {
        :root {
          --app-drawer-width: 256px;
        }
      }

      app-header-layout {
        z-index: 999;
      }

      app-drawer {
        z-index: 1000;
        top: var(--cubex-drawer-offset-top);
        --app-drawer-content-container: {
          @apply --primary-700;
          @apply --shadow-elevation-8dp;
          top: -184px;
        };
      }

      #waterfall {
        z-index: 2;
        position: fixed;
        right: 0;
        top: var(--cubex-drawer-offset-top);
        left: 0;
        width: 100%;
        height: 5px;
        content: "";
        transition: opacity 0.4s;
        pointer-events: none;
        box-shadow: inset 0 5px 3px -3px rgba(0, 0, 0, 0.2);
        will-change: opacity;
        @apply(--app-header-shadow);
      }

      app-drawer-layout {
        /* fix over scrolling on small content pages */
        height: 0;
      }

      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        @apply --primary-800;
      }

      app-header, #flex-toolbar {
        height: var(--cubex-drawer-offset-top);
        line-height: var(--cubex-drawer-offset-top);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      #flex-toolbar {
        z-index: 1000;
        @apply --layout-horizontal;
        width: 100%;
        transition: 0.2s ease !important;
        transition-property: background-color, transform, left, margin !important;
        @apply --primary-700;
      }

      #flex-toolbar paper-icon-button {
        @apply --primary-700-text-secondary;
      }

      #flex-toolbar paper-icon-button:hover {
        @apply --primary-700-text;
      }

      :host([drawer-opened]) #flex-toolbar {
        @apply --primary-800;
        margin-left: var(--app-drawer-width, 268px) !important;
      }

      #flex-toolbar cubex-search {
        margin: 12px 0;
      }

      #search-shortcut {
        @apply --primary-700-text-secondary;
        display: none;
      }

      @media screen and (max-width: 800px) {
        #search-shortcut {
          display: block;
        }
      }

      .spread {
        @apply --layout-flex;
      }

      cubex-toolbar {
        text-align: right;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: flex-end;
      }

      :host([drawer-opened]) cubex-pinned-apps {
        padding-left: 12px;
      }

      :host([focus-search]) #burger,
      :host([focus-search]) #search-shortcut,
      :host([focus-search]) #user-panel-action,
      :host([focus-search]) cubex-pinned-apps,
      :host([focus-search]) cubex-toolbar,
      :host([drawer-opened]) #burger,
      :host([drawer-opened]) #search-shortcut,
      :host([drawer-opened]) #user-panel-action,
      :host([drawer-opened]) cubex-search,
      :host([drawer-opened]) cubex-toolbar {
        display: none;
      }

      #user-panel-action:hover {
        @apply --text-primary;
      }

      #user-panel-action {
        --cube-icon-color: var(--primary-700-text-color);
        @apply --text-secondary;
        position: relative;
        margin: 15px 8px;
      }

      #user-panel-action:before,
      #user-panel-action:after {
        content: '';
        display: inline-block;
        border: 5px solid transparent;
        position: absolute;
        top: 13px;
      }

      :host([user-drawer-state="0"]) #user-panel-action:before {
        border-right-color: var(--primary-700-text-color);
        left: -6px;
      }

      :host(:not([user-drawer-state="0"])) #user-panel-action:after {
        border-left-color: var(--primary-700-text-color);
        right: -6px;
      }

      cube-action[hidden] {
        display: none;
      }

      cubex-user-drawer-items cube-action {
        padding: 12px
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <iron-media-query query="(min-width: 1000px)" query-matches="{{_peek}}"></iron-media-query>
    <iron-media-query query="(max-width: 375px)" query-matches="{{_narrow}}"></iron-media-query>

    <app-drawer-layout id="adl" fullbleed force-narrow>
      <app-drawer id="drawer" opened="{{drawerOpened}}">
        <cubex-shell-drawer></cubex-shell-drawer>
      </app-drawer>

      <app-header-layout>
        <app-header fixed>
          <div id="flex-toolbar">
            <div id="burger">
              <paper-icon-button icon="menu" on-tap="_toggleDrawer"></paper-icon-button>
            </div>
            <cubex-pinned-apps></cubex-pinned-apps>
            <div class="spread"></div>
            <cubex-search id="search" focus-search="[[focusSearch]]"></cubex-search>
            <div class="spread"></div>
            <div id="search-shortcut">
              <paper-icon-button icon="search" on-tap="_searchFocus"></paper-icon-button>
            </div>
            <cubex-toolbar id="toolbar"></cubex-toolbar>
            <cube-action icon="icons:chrome-reader-mode" hidden="[[_narrow]]" id="user-panel-action" size="24"
                         on-tap="_toggleUserDrawer"></cube-action>
          </div>
        </app-header>
      </app-header-layout>
      <div id="waterfall"></div>

      <cube-preferences name="userDrawerPosition" value="{{userDrawerState}}"></cube-preferences>
      <cubex-drawer id="userDrawer" swipe-open="[[_touchEnabled()]]" state="{{userDrawerState}}"
                      preferred-state="[[userDrawerState]]" position="right">
        <cubex-drawer-content slot="drawer-content">
          <cubex-user-drawer></cubex-user-drawer>
        </cubex-drawer-content>

        <cubex-app-loader route="[[route]]"></cubex-app-loader>
      </cubex-drawer>

    </app-drawer-layout>

  </template>
  <script>
    Polymer(
      {
        is:                  'cubex-shell',
        properties:          {
          drawerOpened:    {type: Boolean, reflectToAttribute: true},
          focusSearch:     {type: Boolean, reflectToAttribute: true},
          userDrawerState: {type: Number, reflectToAttribute: true}
        },
        observers:           [
          '_viewChanged(_peek,_narrow)'
        ],
        keyBindings:         {
          '.': '_toggleDrawer',
          '/': '_launchSearch',
          '?': '_keyboardHelp'
        },
        attached:            function ()
                             {
                               this.keyEventTarget = document.body;
                               document.querySelector('body').removeAttribute('shellunloaded');
                               this._resetLayoutDelayed();
                               document.addEventListener(
                                 'cubex-drawer-state-changed', this._resetLayoutDelayed.bind(this)
                               );
                             },
        _resetLayoutDelayed: function ()
                             {
                               // delay due to 0.2s animation
                               this.async(this._resetLayout, 200);
                             },
        _resetLayout:        function ()
                             {
                               this.$.adl.resetLayout();
                             },
        _keyboardHelp:       function (e)
                             {
                               if(this._isValidKeyPress(e))
                               {
                                 this.$.drawer.close();
                                 this.$.toolbar.openKeyboardHelp();
                                 e.preventDefault();
                               }
                             },
        _viewChanged:        function (peek, narrow)
                             {
                               if(narrow)
                               {
                                 this.$.userDrawer.setMaxState(0);
                               }
                               else
                               {
                                 this.$.userDrawer.setMinState(0);
                                 this.$.userDrawer.setMaxState(2);

                                 if(peek && this.$.userDrawer.state == 0)
                                 {
                                   this.$.userDrawer.setState(1);
                                 }
                               }

                               this.updateStyles();
                             },
        _setupClose:         false,
        _blurSearch:         function ()
                             {
                               this.focusSearch = false;
                               this.unlisten(this.$.search, 'blur', '_blurSearch');
                             },
        _searchFocus:        function ()
                             {
                               this.focusSearch = true;
                               this.$.search.focus();
                               this.listen(this.$.search, 'blur', '_blurSearch');
                             },
        _launchSearch:       function (e)
                             {
                               if(this._isValidKeyPress(e))
                               {
                                 this.$.drawer.close();
                                 e.preventDefault();
                                 if(this.$.search.getComputedStyleValue('display') == 'block')
                                 {
                                   this.$.search.focus();
                                 }
                                 else
                                 {
                                   this._searchFocus();
                                 }
                               }
                             },
        _prepareDrawer:      function ()
                             {
                               if(!this._setupClose)
                               {
                                 this.$$('cubex-shell-drawer').addEventListener(
                                   'closeParent', function (e) {this.$.drawer.close();}.bind(this)
                                 );
                                 this._setupClose = true;
                               }
                             },
        _toggleDrawer:       function (e)
                             {
                               this._prepareDrawer();
                               if(this._isValidKeyPress(e))
                               {
                                 this.$.drawer.toggle();
                                 e.preventDefault();
                               }
                             },

        _isValidKeyPress:  function (e)
                           {
                             if(e && e.detail && e.detail.keyboardEvent)
                             {
                               return e.detail.keyboardEvent.target.tagName == 'BODY';
                             }
                             return true;
                           },
        _toggleUserDrawer: function ()
                           {
                             if(this.$.userDrawer.maxState == 0 || this.$.userDrawer.state == 0)
                             {
                               this.$.userDrawer.setMaxState(2);
                               this.$.userDrawer.setState(1);
                             }
                             else
                             {
                               this.$.userDrawer.setMaxState(0);
                             }
                           },

        behaviors: [
          Polymer.IronA11yKeysBehavior,
          Polymer.CubeTouchEnabledBehavior,
          Polymer.CubeIteratorBehavior
        ]
      }
    );
  </script>
</dom-module>
