<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../app-route/app-route.html">
<link rel="import" href="../../cube-action/cube-action.html">
<link rel="import" href="../../cube-list/cube-li.html">
<link rel="import" href="../../cube-pagelet/cube-pagelet-content.html">
<link rel="import" href="../../cube-behavior/cube-iterator-behavior.html">
<link rel="import" href="../../cube-behavior/cube-service-behavior.html">
<link rel="import" href="../../page-title/page-title.html">
<link rel="import" href="../cubex-drawer/cubex-drawer.html">
<link rel="import" href="../cubex-hash/cubex-hash.html">
<link rel="import" href="../cubex-category/cubex-category.html">
<link rel="import" href="../cubex-category/cubex-category-page.html">
<link rel="import" href="../cubex-category/cubex-category-hero.html">
<link rel="import" href="cubex-app.html">
<link rel="import" href="cubex-app-title.html">
<link rel="import" href="cubex-app-header.html">
<link rel="import" href="cubex-app-menu.html">
<link rel="import" href="cubex-app-spinner.html">

<dom-module id="cubex-app-loader" attributes="route vendor">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
        --cubex-drawer-width: 256px;
      }

      :link, :visited {
        color: var(--accent-400-color);
      }

      :link:hover {
        color: var(--accent-700-color);
      }

      #hero {
        width: 100%;
        align-self: flex-end;
        margin-top: -64px;
        padding-top: 64px;
      }

      #hero cube-hero {
        padding-top: 48px;
        overflow: visible;
      }

      #hero[hidden] {
        display: none;
      }
    </style>

    <app-route id="projectRoute" route="[[route]]" pattern="/:project" data="{{projectRouteData}}"
               tail="{{projectTail}}" query-params="{{appQuery}}"></app-route>
    <app-route id="vendorRoute" route="[[projectTail]]" pattern="/:vendor" data="{{vendorRouteData}}"
               tail="{{vendorTail}}"></app-route>
    <app-route id="appRoute" route="[[vendorTail]]" pattern="/:app" data="{{appRouteData}}"
               tail="{{appPath}}" active="{{_appActive}}"></app-route>

    <cubex-registry project-data="{{projectData}}"></cubex-registry>

    <cubex-app-definition gaid="[[_appGaid]]" app-data="{{appData}}"></cubex-app-definition>

    <cube-websocket vendor="cubex" app="registry" auto on-message="_appsChanged"></cube-websocket>
    <cube-resource id="integrationsResource" auto auth url="[[_integrationsPath]]" data="{{_integrations}}"
                   headers="[[_pageDefinitionHeaders]]" ttl="3600"></cube-resource>
    <cube-resource auto auth url="[[_pageDefinitionPath]]" data="{{_pageDefinitionHtml}}" xhr="{{_pageXhr}}"
                   headers="[[_pageDefinitionHeaders]]" status="{{_pageDefinitionStatus}}"></cube-resource>

    <cubex-category id="cat"></cubex-category>

    <page-title page-title="[[pageData.title]]"></page-title>

    <cubex-app id="app" app-data="[[appData]]" page-data="[[pageData]]"
               back-path="[[_backPath]]" page-path="[[_pagePath]]"
               header-menu="[[_headerMenus]]" header-actions="[[_headerActions]]"
               page-menu="[[_pageMenus]]" page-actions="[[_pageActions]]"
               panels="[[_panels]]"
               has-hero="[[_pageDefinitionContentHasHero]]">
      <cubex-drawer-content slot="drawer-content" id="appDrawerContent">
        <cubex-app-menu app-data="[[appData]]"></cubex-app-menu>
      </cubex-drawer-content>
      <cubex-app-spinner slot="spinner" hidden$="[[!_pageSpinnerVisible]]"></cubex-app-spinner>

      <cube-pagelet-content id="hero" slot="hero" html="[[_pageDefinitionHtml]]"
                            hidden$="[[!_pageDefinitionContentHasHero]]"></cube-pagelet-content>

      <cube-resource auto auth url="[[_pageContentPath]]" headers="[[_pageContentHeaders]]"
                     status="{{_pageContentStatus}}" data="{{_pageContentHtml}}"></cube-resource>
      <cube-pagelet-content id="content" html="[[_pageContentHtml]]"></cube-pagelet-content>
    </cubex-app>
  </template>

  <script>
    Polymer(
      {
        is:         'cubex-app-loader',
        properties: {
          _project: {type: String},
          _appGaid: {type: String, computed: '_computeAppGaid(vendorRouteData,appRouteData)'},

          _pageDefinitionPath:           {type: String},
          _pagePath:                     {type: String},
          _loadedPath:                   {type: String, value: ''},
          _pageXhr:                      {type: Object},
          _pageDefinitionHeaders:        {type: Object, computed: '_computeHeaders(_project,"page-definition")'},
          _pageDefinitionHtml:           {type: String},
          _pageDefinitionContentHasHero: {type: Boolean},
          _pageSpinnerVisible:           {type: Boolean, value: false},
          pageData:                      {type: Object, notify: true},
          appData:                       {type: Object, notify: true},
          _backPath:                     {
            type:     String,
            computed: '_computedBackPath(projectRouteData.project,appData.GlobalAppID,pageData.backPath)'
          },

          _pageContentPath:    {type: String},
          _pageContentHeaders: {type: Object, computed: '_computeHeaders(_project)'},
          _pageContentHtml:    {type: String},

          _integrationsPath: {type: String},
          _integration:      {type: Object, value: null},

          _headerMenus:   {type: Array},
          _headerActions: {type: Array},
          _pageMenus:     {type: Array},
          _pageActions:   {type: Array},
          _panels:        {type: Array}
        },
        observers:  [
          '_updateProject(projectRouteData.project)',
          '_pathChanged(route.path)',
          '_updateHeaders(_pageXhr)',
          '_updateIntegration(_integrations,appPath.path,_pageDefinitionPath,projectData)',
          '_updateHeader(_integration,_integrations,appData,projectData)',
          '_updateSidebar(_integration,_integrations,appPath,projectData)',
          '_pageHtmlChanged(_pageDefinitionHtml,_pageContentHtml)'
        ],

        _appsChanged: function (e)
                      {
                        if(e.detail.action == 'install' || e.detail.action == 'uninstall')
                        {
                          this.$.integrationsResource.update(true);
                        }
                      },

        _computeAppGaid: function (vendorRouteData, appRouteData)
                         {
                           if(vendorRouteData && vendorRouteData.vendor && appRouteData && appRouteData.app)
                           {
                             return vendorRouteData.vendor + '/' + appRouteData.app;
                           }
                           return null;
                         },

        _updateProject: function (project)
                        {
                          if(this._project !== project)
                          {
                            this._project = project;
                          }
                        },

        _computeHeaders: function (project, resourceType)
                         {
                           var headers = {};
                           if(project)
                           {
                             headers['x-cube-project'] = project;
                           }
                           if(resourceType)
                           {
                             headers['x-cube-resource-type'] = resourceType;
                           }
                           return headers;
                         },

        _computedBackPath: function (project, gaid, path)
                           {
                             if(project && path && path.length > 0)
                             {
                               return '/' + project + '/' + gaid + path;
                             }
                             return '';
                           },

        _updateHeader: function (integration, integrations, appData)
                       {
                         if(integrations)
                         {
                           var self = this;
                           var headerActions = this._integrations.HeaderActions;
                           var headerMenu = this._integrations.HeaderMenuItems;
                           var newActions = [];
                           var newMenu = [];
                           if(headerMenu && appData && this.projectData && this.projectData.AppSummary)
                           {
                             headerMenu = headerMenu.sort(
                               function (a, b)
                               {
                                 // if one item is within the current app and one isn't, move the current one up
                                 if((a.Hook.indexOf(a.GlobalAppID) == 0) != (b.Hook.indexOf(b.GlobalAppID) == 0))
                                 {
                                   return (a.GlobalAppID == appData.GlobalAppID) ? -1 : 1;
                                 }
                                 var cA = a.Title, cB = b.Title;
                                 // if not current app, use category
                                 if(a.Hook.indexOf(a.GlobalAppID) !== 0 && b.Hook.indexOf(b.GlobalAppID) !== 0)
                                 {
                                   cA = self.projectData.AppSummary[a.GlobalAppID].category;
                                   cB = self.projectData.AppSummary[b.GlobalAppID].category;
                                 }
                                 // comparisons match, no change
                                 if(cA == cB)
                                 {
                                   return 0;
                                 }
                                 // A is less than B, move A up
                                 return (cA < cB) ? -1 : 1;
                               }
                             );

                             var categoriesAdded = [];
                             for(var i in headerMenu)
                             {
                               if(headerMenu.hasOwnProperty(i))
                               {
                                 if(headerMenu[i].Hook.indexOf(headerMenu[i].GlobalAppID) === 0)
                                 {
                                   newMenu.push(
                                     {
                                       Title: headerMenu[i].Title,
                                       Path:  '/' + this.projectRouteData.project + '/' + headerMenu[i].Hook + '/_/' + headerMenu[i].ID,
                                       Mode:  'page'
                                     }
                                   );
                                 }
                                 else
                                 {
                                   var category = this.projectData.AppSummary[headerMenu[i].GlobalAppID].category;
                                   if(categoriesAdded.indexOf(category) == -1)
                                   {
                                     newMenu.push(
                                       {
                                         Title: this.$.cat.getCategory(category),
                                         Path:  '/' + this.projectRouteData.project + '/' + headerMenu[i].Hook + '/~/' + category
                                                + '/h-' + this._hash32(headerMenu[i].GlobalAppID + '/' + headerMenu[i].ID),
                                         Match: '/' + this.projectRouteData.project + '/' + headerMenu[i].Hook + '/~/' + category,
                                         Mode:  'page'
                                       }
                                     );
                                     categoriesAdded.push(category);
                                   }
                                 }
                               }
                             }
                           }

                           if(headerActions && appData && this.projectData && this.projectData.AppSummary)
                           {
                             for(var j in headerActions)
                             {
                               if(headerActions.hasOwnProperty(j))
                               {
                                 var action = headerActions[j];
                                 newActions.push(
                                   {
                                     Title:   action.Title,
                                     Path:    action.Mode == 'dialog'
                                                ? '//' + this.getServiceHost('apps') + '/' + action.GlobalAppID + '/' + action.Path
                                                : '/' + this.projectRouteData.project + '/' + action.Hook + '/_/' + action.ID,
                                     Icon:    action.Icon,
                                     Mode:    action.Mode,
                                     Primary: action.GlobalAppID == 'fortifiplatform/customers'
                                   }
                                 );
                               }
                             }
                           }
                         }
                         this._headerMenus = newMenu;
                         this._headerActions = newActions;
                       },

        _updateSidebar: function (integration, integrations)
                        {
                          var pageMenus = [],
                            pageActions = [],
                            panels = [];

                          if(integrations && this.projectData && this.projectData.AppSummary)
                          {
                            var pathMatches = this._parsePath(this.appPath.path);
                            if(integration && pathMatches.type == '~')
                            {
                              var
                                intData = this.projectData.AppSummary[integration.GlobalAppID],
                                category = intData.category,
                                headerMenu = this._integrations.HeaderMenuItems;

                              headerMenu = headerMenu.sort(
                                function (a, b)
                                {
                                  if(a.Title == b.Title)
                                  {
                                    return 0;
                                  }
                                  return (a.Title < b.Title) ? -1 : 1;
                                }
                              );

                              for(var i in headerMenu)
                              {
                                if(headerMenu.hasOwnProperty(i))
                                {
                                  if(this.projectData.AppSummary[headerMenu[i].GlobalAppID].category == category)
                                  {
                                    pageMenus.push(
                                      {
                                        Title:       headerMenu[i].Title,
                                        Description: headerMenu[i].Description,
                                        Path:        this._getBasePath() + pathMatches.pagePath + '/~/' + category
                                                     + '/h-' + this._hash32(headerMenu[i].GlobalAppID + '/' + headerMenu[i].ID),
                                        Mode:        'page'
                                      }
                                    );
                                  }
                                }
                              }
                              if(pageMenus.length === 1)
                              {
                                pageMenus = [];
                              }
                            }
                            else
                            {
                              if(this._integrations.PageMenuItems)
                              {
                                var items = this._integrations.PageMenuItems.sort(
                                  function (a, b)
                                  {
                                    if(a.Title == b.Title)
                                    {
                                      return 0;
                                    }
                                    return (a.Title < b.Title) ? -1 : 1;
                                  }
                                );
                                for(var j in items)
                                {
                                  if(items.hasOwnProperty(j))
                                  {
                                    pageMenus.push(
                                      {
                                        Title:       items[j].Title,
                                        Description: items[j].Description,
                                        Href:        '//' + this.getServiceHost('apps') + '/' + items[j].Path,
                                        Mode:        items[j].Mode
                                      }
                                    );
                                  }
                                }
                              }

                              pageActions = this._integrations.PageActions;
                              panels = this._integrations.Panels;
                            }
                          }
                          this._pageMenus = pageMenus;
                          this._pageActions = pageActions;
                          this._panels = panels;
                        },

        _pathChanged: function (path)
                      {
                        if(path !== undefined)
                        {
                          if(this.$.appRoute.active)
                          {
                            if(this.route.path !== this._loadedPath)
                            {
                              this._loadedPath = this.route.path;

                              var self = this,
                                pathMatches = this._parsePath(this.appPath.path),
                                fullPath = '/' + this.vendorRouteData.vendor + '/' + this.appRouteData.app + pathMatches.pagePath,
                                integrationPath = fullPath;
                              this._pagePath = '/' + this.projectRouteData.project + fullPath;

                              if(pathMatches.type == '_')
                              {
                                integrationPath += '/_/' + pathMatches.typeId;
                              }

                              var ip = '//' + this.getServiceHost('apps') + '/cubex/integrations/integrations.json?hook=' + integrationPath;
                              if(this._integrationsPath != ip)
                              {
                                this._integrationsPath = ip;
                              }

                              var pdp = '//' + this.getServiceHost('apps') + fullPath;
                              if(this._pageDefinitionPath != pdp)
                              {
                                this._addPageSpinner = setTimeout(
                                  function () { self._pageSpinnerVisible = true; }, 50
                                );
                                this._pageDefinitionPath = pdp;
                              }
                            }
                          }
                          else
                          {
                            this._integrationsPath = null;
                            this._pageDefinitionPath = null;
                            this._pageContentPath = null;
                            this._loadedPath = null;
                            this.appRouteData = {};
                            this.appData = null;

                            if((!this.$.appRoute.active) && this.$.vendorRoute.active && this.vendorRouteData.vendor)
                            {
                              if(this.vendorRouteData.vendor[0] == '_')
                              {
                                var cat = this.vendorRouteData.vendor.substring(1),
                                  catName = this.$.cat.getCategory(cat);
                                this._pagePath = this.route.path;
                                this.pageData = {
                                  title:      'Category ' + catName,
                                  breadcrumb: [{Title: catName, Url: this.route.path}]
                                };
                                this._pageDefinitionHtml = '<cubex-category-hero category="' + cat + '"></cubex-category-hero>';
                                this._pageContentHtml = '<cubex-category-page category="' + cat + '"></cubex-category-page>';
                                this._pageDefinitionContentHasHero = true;
                              }
                              else
                              {
                                var vendor = this.vendorRouteData.vendor;
                                this._pagePath = this.route.path;
                                this.pageData = {
                                  title:      'Vendor ' + vendor,
                                  breadcrumb: [{Title: vendor, Url: this.route.path}]
                                };
                                this._pageDefinitionHtml = 'vendor Hero';
                                this._pageContentHtml = 'vendor page';
                              }
                            }
                            else
                            {
                              this.pageData = null;
                              this._pageDefinitionHtml = '';
                              this._pageContentHtml = '';
                            }
                          }
                        }
                      },

        _updateIntegration: function ()
                            {
                              var integration = null, contentPath = this._pageDefinitionPath;

                              if(this._integrations && this.projectData && this.projectData.AppSummary
                                && this.appPath && this.appPath.path)
                              {
                                var pathMatches = this._parsePath(this.appPath.path);
                                var items = null;
                                if(pathMatches.pageletId)
                                {
                                  var hashType = pathMatches.pageletId.substr(0, 2),
                                    hash = pathMatches.pageletId.substr(2);
                                  if(hashType == 'm-')
                                  {
                                    items = this._integrations.PageMenuItems;
                                  }
                                  else if(hashType == 'a-')
                                  {
                                    items = this._integrations.PageActions;
                                  }
                                  else if(hashType == 'h-')
                                  {
                                    items = this._integrations.HeaderMenuItems;
                                  }
                                }
                                else if(pathMatches.type == '~' && pathMatches.typeId)
                                {
                                  items = this._integrations.HeaderMenuItems;
                                }
                                else if(pathMatches.type == '_' && pathMatches.typeId)
                                {
                                  items = this._integrations.HeaderMenuItems;
                                }

                                if(items)
                                {
                                  items = items.sort(
                                    function (a, b)
                                    {
                                      if(a.Title == b.Title)
                                      {
                                        return 0;
                                      }
                                      return (a.Title < b.Title) ? -1 : 1;
                                    }
                                  );
                                  for(var i in items)
                                  {
                                    if(items.hasOwnProperty(i))
                                    {
                                      var gaidHash = this._hash32(items[i].GlobalAppID + '/' + items[i].ID);
                                      if(
                                        ((!pathMatches.pageletId)
                                          && (pathMatches.type == '~' && pathMatches.typeId == this.projectData.AppSummary[items[i].GlobalAppID].category)
                                          || (pathMatches.type == '_' && items[i].GlobalAppID == this.appData.GlobalAppID && items[i].ID == pathMatches.typeId)
                                        )
                                        || (gaidHash == hash)
                                      )
                                      {
                                        integration = items[i];
                                        contentPath = '//' + this.getServiceHost('apps') + '/' + items[i].GlobalAppID + '/' + items[i].Path;
                                        break;
                                      }
                                    }
                                  }
                                }
                              }
                              if(integration != this._integration)
                              {
                                this._integration = integration;
                              }
                              if(contentPath != this._pageContentPath)
                              {
                                this._pageContentPath = contentPath;
                              }
                            },

        _updateHeaders: function ()
                        {
                          var cubeHeaderRegex = /x-cube-([a-z\-]+): (.*)[\n\r]*/g,
                            headers = {};
                          if(this._pageXhr)
                          {
                            var fn = function (_, v) { return v.toUpperCase(); };
                            while(matches = cubeHeaderRegex.exec(this._pageXhr.getAllResponseHeaders()))
                            {
                              headers[matches[1].replace(/-([a-z])/, fn)] = matches[2];
                            }
                          }
                          this.pageData = headers;

                          if(this._addPageSpinner)
                          {
                            clearTimeout(this._addPageSpinner);
                          }
                          this._pageSpinnerVisible = false;
                        },

        _parsePath: function (path)
                    {
                      var matches = path.match(/(.+?)(\/(_|~)(\/([^\/]+)(\/([^\/]+))?(.*)))?$/);
                      if(matches)
                      {
                        return {
                          pagePath:  matches[1],
                          type:      matches[3],
                          typeId:    matches[5],
                          pageletId: matches[7],
                          subPath:   matches[8]
                        };
                      }
                      return {
                        pagePath:  path,
                        type:      '',
                        typeId:    '',
                        pageletId: '',
                        subPath:   ''
                      };
                    },

        _getBasePath: function ()
                      {
                        return '/' + this.projectRouteData.project + '/' + this.vendorRouteData.vendor + '/' + this.appRouteData.app;
                      },

        _pageHtmlChanged: function ()
                          {
                            this._pageDefinitionContentHasHero = this.$.hero.querySelector('cube-hero');
                          },

        behaviors: [
          Polymer.CubeIteratorBehavior,
          Polymer.CubeServiceBehavior,
          Polymer.CubeHashBehavior
        ]
      }
    )
  </script>
</dom-module>
