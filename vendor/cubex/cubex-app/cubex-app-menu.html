<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-list/cube-list.html">
<link rel="import" href="../../cube-icon/cube-icon.html">
<link rel="import" href="../../cube-behavior/cube-element-path-behavior.html">
<link rel="import" href="../../cube-behavior/cube-iterator-behavior.html">
<link rel="import" href="../../cube-behavior/cube-i18n-behavior.html">
<link rel="import" href="../../bind-factory/bind-factory.html">
<link rel="import" href="../cubex-route/cubex-route.html">

<dom-module id="cubex-app-menu" attributes="app-data project-data">
  <template strip-whitespace>
    <style>
      :host {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        position: absolute;

        --cube-li-style: {
          @apply --paper-font-body2;
        }
      }

      :host cubex-app-title {
        align-self: flex-start;
        min-height: 64px;
      }

      .flex {
        flex: auto;
      }

      :host {
        --cube-list-items-container: {
          width: 100%;
        }
      }

      :host > #content {
        display: flex;
        flex-direction: column;
        align-content: flex-start;
        height: 100%;
        overflow: hidden;
      }

      :host cube-list {
        width: 100%;
        display: flex;
        overflow-y: scroll;
        overflow-x: hidden;
        min-height: 100px;
      }

      :host cube-li {
        cursor: pointer;

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        width: 100%;

        color: var(--text-color-secondary);
      }

      :host cubex-link:hover {
        --cube-li-style: {
          @apply --paper-font-body2;
          background: var(--theme-500-color);
        };
        --cube-li-content-style: {
          color: var(--accent-400-color);
        };
      }

      :host cubex-link[active] cube-li {
        --cube-li-style: {
          @apply --paper-font-body2;
          background: var(--accent-50-color);
        };
        --cube-li-content-style: {
          color: var(--accent-400-color);
        };
      }

      :host cubex-link[active] cube-li:before {
        content: ' ';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background: var(--accent-700-color);
      }

      #toggler {
        @apply --accent-400;
        @apply --cubex-app-menu-toggler;
      }

      #toggler:hover {
        @apply --accent-700;
      }

      #toggler cube-icon {
        position: relative;
      }

      #toggler cube-icon:before,
      #toggler cube-icon:after {
        content: '';
        display: inline-block;
        border: 5px solid transparent;
        position: absolute;
        top: 8px;
      }

      #toggler cube-icon:before {
        left: -12px;
      }

      #toggler cube-icon:after {
        right: -12px;
      }

      #toggler[drawer-open] cube-icon:before {
        border-right-color: var(--accent-400-text-color);
      }

      #toggler:not([drawer-open]) cube-icon:after {
        border-left-color: var(--accent-400-text-color);
      }
    </style>

    <cubex-route project-id="{{projectId}}"></cubex-route>

    <div id="content">
      <template restamp is="dom-if" if="[[appData.Name]]">
        <a href="[[_titleLink]]" on-tap="_collapseDrawer">
          <cubex-app-title icon="[[_titleIcon]]" title="[[i18n('app_name')]]" vendor="[[appData.VendorID]]"
                           trusted-vendor="[[appData.TrustedVendor]]"></cubex-app-title>
        </a>
      </template>

      <template restamp is="dom-if" if="[[_navigation]]">
        <cube-list>
          <template is="dom-repeat" items="[[_navigation]]">
            <cubex-link href="[[item.Path]]" on-tap="_collapseDrawer">
              <cube-li compact-icon>
                <cube-icon slot="icon" icon="[[item.Icon]]"></cube-icon>
                [[item.i18n_name]]
                <paper-ripple></paper-ripple>
              </cube-li>
            </cubex-link>
          </template>
        </cube-list>
      </template>

      <div class="flex"></div>

      <cube-li id="toggler" on-tap="_toggleDrawer" drawer-open$="[[_drawerOpen]]" compact-icon>
        <cube-icon icon="icons:chrome-reader-mode" slot="icon"></cube-icon>
        <template restamp is="dom-if" if="[[_drawerOpen]]">
          [[i18n('collapse')]]
        </template>
        <template restamp is="dom-if" if="[[!_drawerOpen]]">
          [[i18n('keep_out')]]
        </template>
        <paper-ripple></paper-ripple>
      </cube-li>
    </div>
  </template>

  <script>
    Polymer(
      {
        is: 'cubex-app-menu',

        properties: {
          appData:     {type: Object, notify: true, observer: '_resetResources'},
          projectData: {type: Object, notify: true, observer: '_resetResources'},
          _navigation: {type: Array, computed: '_updateNav(appData.Navigation,resources)'},
          _titleIcon:  {type: String, computed: '_calculateTitleIcon(appData,projectData)'},
          _titleLink:  {type: String, computed: '_calculateTitleLink(appData,projectData)'},
          _drawerOpen: {type: Boolean, value: false}
        },

        _updateNav: function (nav, resources)
                    {
                      if(nav && resources)
                      {
                        for(var i in nav)
                        {
                          if(nav.hasOwnProperty(i))
                          {
                            var i18nKey = 'nav_' + nav[i].ID + '_name';
                            nav[i].i18n_name = this.i18n(i18nKey);
                          }
                        }
                        return nav;
                      }
                      return [];
                    },

        attached: function ()
                  {
                    this._resetResources();
                    this._refreshDrawerState();
                    document.addEventListener('cubex-drawer-state-changed', this._refreshDrawerState.bind(this));
                  },

        _refreshDrawerState: function ()
                             {
                               this._drawerOpen = this._getApp().drawer.state === 2;
                             },

        _getApp:         function ()
                         {
                           var app = null;
                           this.iterate(
                             this.getPath(this), function (parent)
                             {
                               if(parent.tagName === 'CUBEX-APP')
                               {
                                 app = parent;
                                 return false;
                               }
                             }
                           );
                           return app;
                         },
        _setDrawerState: function (state)
                         {
                           this._getApp().setDrawerState(state);
                         },
        _collapseDrawer: function ()
                         {
                           var app = this._getApp();
                           if(app.narrow)
                           {
                             app.drawer.close();
                           }
                           else if(app.drawer.state !== 2)
                           {
                             this._setDrawerState(1);
                           }
                         },
        _toggleDrawer:   function ()
                         {
                           var app = this._getApp();
                           if(app.narrow)
                           {
                             app.drawer.toggle();
                           }
                           else if(app.drawer.state === 2)
                           {
                             this._setDrawerState(1);
                           }
                           else
                           {
                             this._setDrawerState(2);
                           }
                         },

        _concat:   function ()
                   {
                     return Array.prototype.slice.call(arguments).join('');
                   },
        _trimPath: function (path)
                   {
                     return (path || '').replace(/^\/+/, '');
                   },

        _resetResources:     function ()
                             {
                               // reset resources
                               var newRes = {
                                 'collapse': {'en': 'Collapse Menu', 'fr': 'RÃ©duire Menu'},
                                 'keep_out': {'en': 'Keep Menu Out', 'fr': 'Gardez Menu Out'}
                               };
                               if(this.appData && this.appData.Name)
                               {
                                 newRes['app_name'] = this.appData.Name;
                                 if(this.appData.GroupID)
                                 {
                                   var groupGaid = this.appData.VendorID + "/" + this.appData.GroupID;
                                   if(this.projectData.GroupSummary[groupGaid])
                                   {
                                     var groupData = this.projectData.GroupSummary[groupGaid];
                                     newRes['app_name'] = groupData.name;
                                   }
                                 }
                                 this.iterate(
                                   this.appData.Navigation, function (nav)
                                   {
                                     newRes['nav_' + nav.ID + '_name'] = nav.Name;
                                     newRes['nav_' + nav.ID + '_description'] = nav.Description;
                                   }
                                 );
                               }
                               this.hydrateResources(newRes, true);
                             },
        _calculateTitleIcon: function (appData, projectData)
                             {
                               var icon = "";
                               if(appData)
                               {
                                 icon = appData.Icon;
                                 if(appData.GroupID && projectData)
                                 {
                                   var groupGaid = appData.VendorID + "/" + appData.GroupID;
                                   if(projectData.GroupSummary[groupGaid])
                                   {
                                     icon = projectData.GroupSummary[groupGaid].icon;
                                   }
                                 }
                               }
                               return icon;
                             },
        _calculateTitleLink: function (appData)
                             {
                               var url = "";
                               if(appData)
                               {
                                 if(appData.GroupID)
                                 {
                                   url = "/" + appData.VendorID + "/" + appData.GroupID
                                 }
                                 else
                                 {
                                   url = "/" + appData.VendorID + "/" + appData.AppID
                                 }
                               }
                               return url;
                             },

        behaviors: [
          Polymer.CubeElementPathBehavior,
          Polymer.CubeIteratorBehavior,
          Polymer.CubeI18nBehavior
        ]
      }
    )
  </script>
</dom-module>
