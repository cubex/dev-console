<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../cube-resource/cube-resource.html">
<link rel="import" href="../../cube-behavior/cube-service-behavior.html">
<link rel="import" href="../../cube-websocket/cube-websocket.html">
<link rel="import" href="../cubex-route/cubex-route.html">

<dom-module id="cubex-registry" attributes="project-data user-data">
  <template>
    <cubex-route project-id="{{projectId}}"></cubex-route>

    <cube-resource id="project" auto auth url="//[[getServiceHost('apps')]]/cubex/registry/project.json"
                   data="{{projectData}}" headers="[[_headers]]" ttl="3600"></cube-resource>
    <cube-resource id="user" auto auth url="//[[getServiceHost('apps')]]/cubex/registry/user.json"
                   data="{{userData}}" headers="[[_headers]]" ttl="3600"></cube-resource>

    <cube-websocket auto project="[[projectId]]" vendor="cubex" app="registry"
                    on-message="_appsChanged"></cube-websocket>
  </template>
  <script>
    Polymer(
      {
        is:              'cubex-registry',
        properties:      {
          projectData: {type: Object, notify: true},
          userData:    {type: Object, notify: true},
          _headers:    {type: Object, computed: '_refreshHeaders(projectId)'}
        },
        _refreshHeaders: function (project)
                         {
                           if(project)
                           {
                             return {'x-cube-project': project};
                           }
                           return undefined;
                         },

        _appsChanged: function (e)
                      {
                        if(e.detail.action == 'install' || e.detail.action == 'uninstall')
                        {
                          this.$.project.update(true);
                          this.$.user.update(true);
                        }
                      },

        behaviors: [Polymer.CubeServiceBehavior]
      }
    );
  </script>
</dom-module>
